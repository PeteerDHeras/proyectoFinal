{% extends "base.html" %}
{% block title %}MyPlanner - Tareas{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#42A5F5",
                    "background-light": "#F5F5F5",
                    "background-dark": "#121212",
                    "text-light": "#333333",
                    "text-dark": "#FFFFFF"
                },
                fontFamily: {
                    "display": ["Inter", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.5rem",
                    "lg": "0.75rem",
                    "xl": "1rem",
                    "full": "9999px"
                },
            },
        },
    }
</script>
<style>
    body {
        font-family: 'Inter', sans-serif;
    }
    
    /* Modal de confirmación personalizado */
    .confirm-modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease-out;
    }
    .confirm-modal {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 400px;
        width: 90%;
        animation: slideUp 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
</style>

<main class="flex-1 p-8 bg-background-light text-text-light">
    <div class="flex flex-col gap-8 max-w-4xl mx-auto">

        <!-- Barra de búsqueda -->
        <div class="px-4 py-3">
            <label class="flex flex-col min-w-40 h-12 w-full max-w-lg mx-auto">
                <div class="flex w-full flex-1 items-stretch rounded-xl h-full shadow-sm bg-white border border-gray-300 focus-within:ring-2 focus-within:ring-primary focus-within:border-primary transition-all">
                    <div class="text-gray-500 flex items-center justify-center pl-4">
                        <span class="material-symbols-outlined">search</span>
                    </div>
                    <input id="search-tareas"
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-text-light focus:outline-0 border-0 bg-transparent h-full placeholder:text-gray-400 px-4 pl-2 text-base font-normal rounded-r-xl"
                        placeholder="Buscar tareas por nombre" />
                </div>
            </label>
        </div>

        <!-- Botón Crear Nueva -->
        <div class="px-4">
            <a href="{{ url_for('crear_tarea_view', referer='tareas') }}"
                class="inline-flex items-center justify-center rounded-lg px-4 py-2 bg-green-500 text-white hover:bg-green-600 transition-colors">
                <span class="material-symbols-outlined mr-2">add_task</span>
                Crear nueva tarea
            </a>
        </div>

    <!-- Lista de Tareas -->
    <div id="tareas-list" class="bg-white rounded-xl shadow-sm overflow-hidden">
            {% for tarea in tareas %}
            <div class="flex flex-col sm:flex-row items-start gap-3 sm:gap-4 p-4 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
                <!-- Fila superior: Checkbox + Título + Botones (móvil) -->
                <div class="flex items-start gap-3 w-full">
                    <!-- Checkbox -->
                    <div class="flex-shrink-0 pt-0.5">
                        <input type="checkbox"
                            class="tarea-checkbox h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer"
                            id="tarea-{{ tarea.id }}"
                            data-tarea-id="{{ tarea.id }}"
                            {% if tarea.estado == 1 %}checked{% endif %} />
                    </div>

                    <!-- Contenido Principal -->
                    <div class="flex-grow min-w-0">
                        <div class="flex flex-col gap-2">
                            <!-- Nombre y Descripción -->
                            <div class="flex-grow min-w-0">
                                <h3 class="text-left text-base sm:text-lg text-gray-900 font-medium leading-tight {% if tarea.estado == 1 %}line-through text-gray-500{% endif %}">
                                    {{ tarea.nombre }}
                                </h3>
                                {% if tarea.descripcion %}
                                <p class="text-left text-gray-500 text-sm mt-1 line-clamp-1 {% if tarea.estado == 1 %}line-through{% endif %}">
                                    {{ tarea.descripcion }}
                                </p>
                                {% endif %}
                            </div>
                                    
                            <!-- Metadatos -->
                            <div class="flex flex-wrap items-center gap-2 text-sm">
                                <!-- Prioridad -->
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if tarea.prioridad == 1 %}bg-green-100 text-green-800
                                    {% elif tarea.prioridad == 2 %}bg-blue-100 text-blue-800
                                    {% elif tarea.prioridad == 3 %}bg-yellow-100 text-yellow-800
                                    {% endif %}">
                                    {% if tarea.prioridad == 1 %}Baja
                                    {% elif tarea.prioridad == 2 %}Media
                                    {% else %}Alta{% endif %}
                                </span>

                                <!-- Fecha y (opcional) hora -->
                                <span class="flex items-center text-gray-500 text-xs sm:text-sm">
                                    <span class="material-symbols-outlined text-sm mr-1">event</span>
                                    {{ tarea.fecha_limite }}
                                    {% if tarea.hora_evento %}
                                        <span class="mx-1 text-gray-300">|</span>
                                        <span class="flex items-center">
                                            <span class="material-symbols-outlined text-xs mr-1">schedule</span>
                                            {%- set _hora = tarea.hora_evento|string -%}
                                            {%- if _hora -%}
                                                {{ _hora.split(':')[:2]|join(':') }}
                                            {%- else -%}
                                                --:--
                                            {%- endif -%}
                                        </span>
                                    {% endif %}
                                </span>

                                <!-- Estado -->
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if tarea.estado == 1 %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ tarea.estado_str }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción (en la misma fila en móvil) -->
                    <div class="flex items-start gap-2 flex-shrink-0 sm:hidden">
                        <button data-id="{{ tarea.id }}" data-type="tarea"
                            class="btn-view-task inline-flex items-center justify-center p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                            <span class="material-symbols-outlined text-sm">edit</span>
                        </button>
                        
                        <button type="button"
                                data-tarea-id="{{ tarea.id }}"
                                data-tarea-nombre="{{ tarea.nombre }}"
                                class="btn-delete-tarea inline-flex items-center justify-center p-2 rounded-lg text-red-500 hover:text-red-700 hover:bg-red-50">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </div>

                <!-- Botones de Acción (Desktop - ocultos en móvil) -->
                <div class="hidden sm:flex items-center gap-2 flex-shrink-0">
                    <button data-id="{{ tarea.id }}" data-type="tarea"
                        class="btn-view-task inline-flex items-center justify-center p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <span class="material-symbols-outlined text-sm">edit</span>
                    </button>
                    
                    <button type="button"
                            data-tarea-id="{{ tarea.id }}"
                            data-tarea-nombre="{{ tarea.nombre }}"
                            class="btn-delete-tarea inline-flex items-center justify-center p-2 rounded-lg text-red-500 hover:text-red-700 hover:bg-red-50">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</main>

<script>
// Sistema de checkbox con actualización automática
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de checkboxes de tareas
    const checkboxes = document.querySelectorAll('.tarea-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const tareaId = this.dataset.tareaId;
            
            // Encontrar la fila más cercana (el div contenedor principal)
            const tareaRow = this.closest('.flex.flex-col.sm\\:flex-row');
            
            // Encontrar h3 y p dentro de esta fila
            const h3 = tareaRow.querySelector('h3');
            const descripcion = tareaRow.querySelector('p');
            const estadoBadge = tareaRow.querySelector('.inline-flex.items-center.px-2\\.5.py-0\\.5.rounded-full.text-xs.font-medium:last-of-type');
            
            // Aplicar estilos inmediatamente (feedback visual inmediato)
            if (this.checked) {
                h3?.classList.add('line-through', 'text-gray-500');
                if (descripcion) {
                    descripcion.classList.add('line-through');
                }
                // Actualizar badge de estado
                if (estadoBadge) {
                    estadoBadge.classList.remove('bg-gray-100', 'text-gray-800');
                    estadoBadge.classList.add('bg-green-100', 'text-green-800');
                    estadoBadge.textContent = 'Completada';
                }
            } else {
                h3?.classList.remove('line-through', 'text-gray-500');
                if (descripcion) {
                    descripcion.classList.remove('line-through');
                }
                // Actualizar badge de estado
                if (estadoBadge) {
                    estadoBadge.classList.remove('bg-green-100', 'text-green-800');
                    estadoBadge.classList.add('bg-gray-100', 'text-gray-800');
                    estadoBadge.textContent = 'Pendiente';
                }
            }
            
            // Enviar al servidor de forma asincrónica
            const estado = this.checked ? 1 : 0;
            fetch(`/tareas/${tareaId}/estado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ estado: estado })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al actualizar el estado');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error:', error);
                // Revertir el cambio si hay error
                if (this.checked) {
                    h3?.classList.remove('line-through', 'text-gray-500');
                    if (descripcion) {
                        descripcion.classList.remove('line-through');
                    }
                    if (estadoBadge) {
                        estadoBadge.classList.remove('bg-green-100', 'text-green-800');
                        estadoBadge.classList.add('bg-gray-100', 'text-gray-800');
                        estadoBadge.textContent = '⏳ Pendiente';
                    }
                    this.checked = false;
                } else {
                    h3?.classList.add('line-through', 'text-gray-500');
                    if (descripcion) {
                        descripcion.classList.add('line-through');
                    }
                    if (estadoBadge) {
                        estadoBadge.classList.remove('bg-gray-100', 'text-gray-800');
                        estadoBadge.classList.add('bg-green-100', 'text-green-800');
                        estadoBadge.textContent = '✅ Completada';
                    }
                    this.checked = true;
                }
            });
        });
    });
    
    // Sistema de confirmación de eliminación personalizado
    function mostrarConfirmacionEliminar(tareaId, tareaNombre) {
        const overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';
        
        overlay.innerHTML = `
            <div class="confirm-modal">
                <div class="flex items-start gap-3 mb-4">
                    <div class="flex-shrink-0">
                        <span class="material-symbols-outlined text-red-500 text-3xl">warning</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">¿Eliminar tarea?</h3>
                        <p class="text-sm text-gray-600">
                            Estás a punto de eliminar la tarea <strong>"${tareaNombre}"</strong>. 
                            Esta acción no se puede deshacer.
                        </p>
                    </div>
                </div>
                <div class="flex gap-3 justify-end">
                    <button id="btn-cancelar-eliminar" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium transition-colors">
                        Cancelar
                    </button>
                    <button id="btn-confirmar-eliminar" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 font-medium transition-colors">
                        Eliminar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Cerrar al hacer clic en el overlay
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
            }
        });
        
        // Botón cancelar
        overlay.querySelector('#btn-cancelar-eliminar').addEventListener('click', () => {
            overlay.remove();
        });
        
        // Botón confirmar
        overlay.querySelector('#btn-confirmar-eliminar').addEventListener('click', () => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/tareas/' + tareaId + '/eliminar';
            document.body.appendChild(form);
            form.submit();
        });
    }
    
    // Event listeners para botones de eliminar
    document.querySelectorAll('.btn-delete-tarea').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const tareaId = this.dataset.tareaId;
            const tareaNombre = this.dataset.tareaNombre;
            mostrarConfirmacionEliminar(tareaId, tareaNombre);
        });
    });
});
</script>
{% endblock %}
