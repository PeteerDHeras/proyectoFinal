<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <!-- Meta viewport para habilitar el responsive real en móviles (iPhone Safari requiere esto) -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
    <title>{% block title %}MyPlanner{% endblock %}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
      <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap"
    rel="stylesheet" />
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

    <!-- Bootstrap y CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.15/index.global.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">


</head>

<body class="bg-light text-light">


    <!-- Responsive Sidebar & Hamburger -->
    <div class="d-flex" style="min-height:100vh;">
        <!-- Hamburger button (visible on mobile) -->
        <button id="sidebarToggle" class="btn btn-dark d-md-none position-fixed shadow-lg" style="top:10px;left:10px;z-index:1100;padding:8px 12px;">
            <span class="fa fa-bars"></span>
        </button>

        <!-- Sidebar -->
        <aside role="complementary" aria-label="Sidebar" id="sidebar" class="bg-dark text-light flex-shrink-0 p-3 sidebar-responsive position-fixed position-md-relative"
            style="width:16rem;transition:left 0.3s,transform 0.3s;left:0;z-index:1090;height:100vh;overflow-y:auto;-webkit-overflow-scrolling:touch;">
            <div class="d-flex flex-column" style="gap:.75rem;min-height:100%;padding-bottom:2rem;">
                <!-- Usuario  -->
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="rounded-circle"
                        style="width:48px; height:48px; background-size:cover; background-position:center; background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuC8w4gQAUyg__Pz5qUJG_E3XTetshO4_YIKFMqQKyOOBlh6o2nVxUlpwcK8JyDMCcUF8NneXp_NFdOXFCTSluwSVi96yPDxjCr4_bA9NhMlxZ6IECv90ys-HxLlB4GqnZAtAG6HUOagtP9ZaHHUOSQokZLtU3FRXAdnI79j-54cE77VNZT2B_vlkf9VOlCVX2nAxdiIjDDpe2LlA52k_A3GnIB5zIhg6KPjO6tcx0bMZclABUUuDnlL5g-EF9gjDyOI9VX7wzjF-pk');">
                    </div>
                    <h1 class="h6 mb-0"><strong>{{ session['usuario']|capitalizar_primera }}</strong></h1>
                </div>

                <!-- Navbar Links -->
                <nav aria-label="Main navigation">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item mb-1">
                            <a href="{{ url_for('dashboard') }}" class="nav-link text-light sidebar-link">
                                <span class="material-symbols-outlined me-2" style="font-size: 18px; vertical-align: middle;">dashboard</span>
                                <span>Panel Principal</span>
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a href="{{ url_for('calendar') }}" class="nav-link text-light sidebar-link">
                                <span class="material-symbols-outlined me-2" style="font-size: 18px; vertical-align: middle;">calendar_month</span>
                                <span>Calendario</span>
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a href="{{ url_for('ver_eventos') }}" class="nav-link text-light sidebar-link">
                                <span class="material-symbols-outlined me-2" style="font-size: 18px; vertical-align: middle;">event</span>
                                <span>Eventos</span>
                            </a>
                        </li>
                        <li class="nav-item mb-1">
                            <a href="{{ url_for('ver_tareas') }}" class="nav-link text-light sidebar-link">
                                <span class="material-symbols-outlined me-2" style="font-size: 18px; vertical-align: middle;">task</span>
                                <span>Tareas</span>
                            </a>
                        </li>
                        <!-- Iniciar/Cerrar sesión -->
                        <li class="nav-item mt-3">
                            {% if session.get('usuario') %}
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-light w-100 mb-2">
                                <span class="material-symbols-outlined me-1" style="font-size: 18px; vertical-align: middle;">logout</span>
                                Cerrar sesión
                            </a>
                            {% else %}
                            <a href="{{ url_for('login') }}" class="btn btn-outline-light w-100 mb-2">
                                <span class="material-symbols-outlined me-1" style="font-size: 18px; vertical-align: middle;">login</span>
                                Iniciar sesión
                            </a>
                            <a href="{{ url_for('register') }}" class="btn w-100" style="background: linear-gradient(to right, rgb(168, 85, 247), rgb(219, 39, 119)); color: white; border: none;">
                                <span class="material-symbols-outlined me-1" style="font-size: 18px; vertical-align: middle;">person_add</span>
                                Registrarse
                            </a>
                            {% endif %}
                        </li>
                    </ul>
                    <!-- Calendario de referencia -->
                <div class="mini-calendar bg-dark border rounded mb-3 mt-6" style="border-color: #495057 !important;">
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2">
                            <button onclick="changeMonth(-1)" class="btn btn-sm btn-link text-light p-0" style="text-decoration: none;">
                                <span class="material-symbols-outlined" style="font-size: 18px;">chevron_left</span>
                            </button>
                            <div id="calendarMonth" class="text-light fw-semibold" style="font-size: 0.85rem;"></div>
                            <button onclick="changeMonth(1)" class="btn btn-sm btn-link text-light p-0" style="text-decoration: none;">
                                <span class="material-symbols-outlined" style="font-size: 18px;">chevron_right</span>
                            </button>
                        </div>
                        <div id="calendarDays" class="d-grid gap-1" style="grid-template-columns: repeat(7, 1fr); font-size: 0.7rem;">
                        </div>
                    </div>
                    
                    <!-- Footer movido al aside -->
                    <footer class="mt-4 pt-3 border-top" style="border-color: #495057 !important;">
                        <div class="text-muted text-center" style="font-size: 0.7rem;">
                            <div class="mb-2">MyPlanner • v1.4</div>
                            <div class="mb-2">© 2025 Pedro de las Heras</div>
                            <div>
                                <a href="{{ url_for('ayuda') }}" class="text-muted me-2" style="text-decoration: none;">Ayuda</a>
                                <a href="{{ url_for('contacto') }}" class="text-muted" style="text-decoration: none;">Contacto</a>
                            </div>
                        </div>
                        {% if session.get('usuario') %}
                        <div class="mt-3">
                            <a href="{{ url_for('ajustes_usuario') }}" class="btn btn-outline-light w-100 d-flex align-items-center justify-content-center gap-2">
                                <span class="material-symbols-outlined" style="font-size: 20px;">settings</span>
                                <span>Ajustes</span>
                            </a>
                        </div>
                        {% endif %}
                    </footer>
                </nav>
            </div>
        </aside>

        <!-- Main Contenido -->
        <!-- Añadido padding superior e inferior para separar el contenido del borde superior
             sin afectar al sidebar. Usamos clases responsive para un término medio en móvil y
             más aire en pantallas grandes. -->
        <main class="flex-grow-1 bg-background-light pt-6 pb-5 px-3 px-md-4 pt-md-8 d-flex flex-column" style="min-height:100vh;overflow-x:hidden;width:100%;margin-left:0;">
            <div class="flex-grow-1">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <!-- Overlay para cerrar sidebar en móvil -->
    <div id="sidebarOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;z-index:1080;"></div>

    <script>
    // Sidebar responsive toggle
    document.addEventListener('DOMContentLoaded', function() {
        var sidebar = document.getElementById('sidebar');
        var toggleBtn = document.getElementById('sidebarToggle');
        var overlay = document.getElementById('sidebarOverlay');
        
        function closeSidebar() {
            if (window.innerWidth < 768) {
                sidebar.style.transform = 'translateX(-100%)';
                overlay.classList.add('d-none');
            }
        }
        
        function openSidebar() {
            if (window.innerWidth < 768) {
                sidebar.style.transform = 'translateX(0)';
                overlay.classList.remove('d-none');
            } else {
                sidebar.style.transform = 'translateX(0)';
                overlay.classList.add('d-none');
            }
        }
        
        // Inicialmente oculto en móvil
        function checkWidth() {
            var main = document.querySelector('main');
            if (window.innerWidth < 768) {
                closeSidebar();
                toggleBtn.style.display = '';
                main.style.marginLeft = '0';
            } else {
                openSidebar();
                toggleBtn.style.display = 'none';
                main.style.marginLeft = '16rem';
            }
        }
        
        checkWidth();
        window.addEventListener('resize', checkWidth);
        
        toggleBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === '') {
                closeSidebar();
            } else {
                openSidebar();
            }
        });
        
        // Cerrar sidebar al hacer click en overlay
        overlay.addEventListener('click', function() {
            closeSidebar();
        });
        
        // Cerrar sidebar al hacer click en un enlace en móvil
        document.querySelectorAll('.sidebar-link').forEach(function(link){
            link.style.fontWeight = '500';
            link.addEventListener('click', function() {
                if (window.innerWidth < 768) {
                    closeSidebar();
                }
            });
        });


        // Mini calendario
        let currentDate = new Date();
        
        function renderCalendar() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            // Cambiado para empezar en Lunes
            const dayNames = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const today = new Date();
            
            document.getElementById('calendarMonth').textContent = monthNames[month] + ' ' + year;
            
            // Obtener primer día del mes (0=Domingo, 1=Lunes, etc.)
            let firstDay = new Date(year, month, 1).getDay();
            // Ajustar para que Lunes sea 0 en lugar de Domingo
            firstDay = (firstDay === 0) ? 6 : firstDay - 1;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '';
            
            // Nombres de días
            dayNames.forEach(day => {
                html += `<div class="text-center text-muted fw-semibold" style="font-size: 0.65rem;">${day}</div>`;
            });
            
            // Espacios vacíos antes del primer día
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            // Días del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && 
                               month === today.getMonth() && 
                               year === today.getFullYear();
                
                if (isToday) {
                    html += `<div class="text-center" style="padding: 1px; aspect-ratio: 1; font-size: 0.65rem; display: flex; align-items: center; justify-content: center;">
                        <span class="bg-primary text-white rounded-circle" style="width: 85%; height: 85%; display: flex; align-items: center; justify-content: center;">${day}</span>
                    </div>`;
                } else {
                    html += `<div class="text-center text-light" style="padding: 1px; aspect-ratio: 1; font-size: 0.65rem; display: flex; align-items: center; justify-content: center;">${day}</div>`;
                }
            }
            
            document.getElementById('calendarDays').innerHTML = html;
        }
        
        window.changeMonth = function(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        };
        
        renderCalendar();
    });
    </script>


    <!-- FullCalendar JS -->
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
        {# Mensajes flash -> se muestran como toast y fallback alert oculto #}
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div style="position:absolute;left:-9999px;top:-9999px;">
                {% for category, msg in messages %}
                    <div class="flash-msg" data-category="{{ category }}">{{ msg }}</div>
                {% endfor %}
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', function(){
                    document.querySelectorAll('.flash-msg').forEach(function(el){
                        var cat = el.getAttribute('data-category') || 'success';
                        var text = el.textContent.trim();
                        try { showToast(text, cat === 'error' ? 'error' : 'success'); } catch(e) {}
                    });
                });
            </script>
        {% endif %}
        {% endwith %}
</body>

</html>