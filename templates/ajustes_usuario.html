{% extends "base.html" %}
{% block title %}MyPlanner - Ajustes{% endblock %}
{% block content %}

<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50 py-12 px-4">
  <div class="w-full max-w-2xl">
    <!-- Header -->
    <div class="text-center mb-6">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-lg mb-4">
        <span class="material-symbols-outlined text-white text-3xl">settings</span>
      </div>
      <h2 class="text-3xl font-bold text-gray-900">Ajustes de Usuario</h2>
      <p class="text-gray-600 text-sm mt-2">Personaliza tu cuenta</p>
    </div>

    <!-- Errores -->
    {% include '_errors.html' %}

    <!-- Success messages -->
    {% if success %}
    <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg">
      <div class="flex items-center">
        <span class="material-symbols-outlined text-green-600 mr-3">check_circle</span>
        <p class="text-green-800 font-medium">{{ success }}</p>
      </div>
    </div>
    {% endif %}

    <!-- Información actual del usuario -->
    <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-8 mb-6">
      <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined">person</span>
        <span>Información de la cuenta</span>
      </h3>
      <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
        <p class="text-sm sm:text-base text-gray-700"><strong>Usuario actual:</strong> {{ session.get('usuario') }}</p>
      </div>
    </div>

    <!-- Cambiar nombre de usuario -->
    <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-8 mb-6">
      <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined">edit</span>
        <span>Cambiar nombre de usuario</span>
      </h3>
      <form method="POST" action="{{ url_for('cambiar_nombre_usuario') }}" class="space-y-4">
        <div>
          <label for="nuevo_nombre" class="block text-sm font-semibold text-gray-700 mb-2">
            Nuevo nombre de usuario *
          </label>
          <input 
            type="text" 
            id="nuevo_nombre" 
            name="nuevo_nombre" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
            placeholder="Ingresa tu nuevo nombre de usuario"
            required
          >
          <p class="text-xs text-gray-500 mt-1 ml-1">
            Entre 3 y 50 caracteres, solo letras y números
          </p>
        </div>
        <div>
          <label for="password_confirmar" class="block text-sm font-semibold text-gray-700 mb-2">
            Contraseña actual (para confirmar) *
          </label>
          <input 
            type="password" 
            id="password_confirmar" 
            name="password_confirmar" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
            placeholder="Confirma tu contraseña actual"
            required
          >
        </div>
        <button 
          type="submit"
          class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold shadow-lg hover:from-indigo-600 hover:to-purple-700 transform hover:scale-[1.02] transition duration-200"
        >
          <span class="material-symbols-outlined text-xl">save</span>
          <span>Cambiar nombre</span>
        </button>
      </form>
    </div>

    <!-- Cambiar contraseña -->
    <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-8 mb-6">
      <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined">lock</span>
        <span>Cambiar contraseña</span>
      </h3>
      <form method="POST" action="{{ url_for('cambiar_password') }}" class="space-y-4">
        <div>
          <label for="password_actual" class="block text-sm font-semibold text-gray-700 mb-2">
            Contraseña actual *
          </label>
          <input 
            type="password" 
            id="password_actual" 
            name="password_actual" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
            placeholder="Tu contraseña actual"
            required
          >
        </div>
        <div>
          <label for="password_nueva" class="block text-sm font-semibold text-gray-700 mb-2">
            Nueva contraseña *
          </label>
          <div class="relative">
            <input 
              type="password" 
              id="password_nueva" 
              name="password_nueva" 
              class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
              placeholder="Ingresa tu nueva contraseña"
              required
            >
            <button 
              type="button"
              onclick="togglePasswordVisibility('password_nueva', 'eye-nueva')"
              class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 transition focus:outline-none border-0 bg-transparent cursor-pointer"
              style="outline: none !important; box-shadow: none !important;"
            >
              <span id="eye-nueva" class="material-symbols-outlined text-xl">visibility</span>
            </button>
          </div>
          <div class="bg-blue-50 rounded-lg p-3 mt-2">
            <p class="text-xs text-blue-800 font-medium mb-1">Requisitos de contraseña:</p>
            <ul class="text-xs text-blue-700 space-y-1 ml-2">
              <li class="flex items-start">
                <span class="material-symbols-outlined text-xs mr-1 mt-0.5">check_circle</span>
                Mínimo 8 caracteres
              </li>
              <li class="flex items-start">
                <span class="material-symbols-outlined text-xs mr-1 mt-0.5">check_circle</span>
                Al menos 1 letra mayúscula
              </li>
              <li class="flex items-start">
                <span class="material-symbols-outlined text-xs mr-1 mt-0.5">check_circle</span>
                Al menos 1 letra minúscula
              </li>
              <li class="flex items-start">
                <span class="material-symbols-outlined text-xs mr-1 mt-0.5">check_circle</span>
                Al menos 1 número
              </li>
            </ul>
          </div>
        </div>
        <div>
          <label for="password_nueva_confirmar" class="block text-sm font-semibold text-gray-700 mb-2">
            Confirmar nueva contraseña *
          </label>
          <div class="relative">
            <input 
              type="password" 
              id="password_nueva_confirmar" 
              name="password_nueva_confirmar" 
              class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
              placeholder="Confirma tu nueva contraseña"
              required
            >
            <button 
              type="button"
              onclick="togglePasswordVisibility('password_nueva_confirmar', 'eye-confirmar')"
              class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 transition focus:outline-none border-0 bg-transparent cursor-pointer"
              style="outline: none !important; box-shadow: none !important;"
            >
              <span id="eye-confirmar" class="material-symbols-outlined text-xl">visibility</span>
            </button>
          </div>
        </div>
        <button 
          type="submit"
          class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 to-pink-600 text-white py-3 px-6 rounded-lg font-semibold shadow-lg hover:from-purple-600 hover:to-pink-700 transform hover:scale-[1.02] transition duration-200"
        >
          <span class="material-symbols-outlined text-xl">lock_reset</span>
          <span>Cambiar contraseña</span>
        </button>
      </form>
    </div>

    <!-- SECCIÓN ADMIN: Solo visible si es_admin -->
    {% if es_admin %}
    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-2xl p-4 sm:p-8 mb-6 border-2 border-purple-200">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
        <span class="material-symbols-outlined text-purple-600 text-2xl sm:text-3xl">admin_panel_settings</span>
        <span>Panel de Administración</span>
      </h2>

      <!-- Tabs de admin -->
      <div class="border-b border-gray-300 mb-6">
        <nav class="-mb-px flex space-x-2 sm:space-x-4 flex-wrap">
          <button onclick="showAdminTab('usuarios')" id="admin-tab-usuarios" class="admin-tab-btn border-b-2 border-purple-500 text-purple-600 py-3 px-1 font-medium text-xs sm:text-sm whitespace-nowrap">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-base">group</span>
              Usuarios
            </span>
          </button>
          <button onclick="showAdminTab('sesiones')" id="admin-tab-sesiones" class="admin-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 font-medium text-xs sm:text-sm whitespace-nowrap">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-base">monitor_heart</span>
              Sesiones
            </span>
          </button>
          <button onclick="showAdminTab('eventos')" id="admin-tab-eventos" class="admin-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 font-medium text-xs sm:text-sm whitespace-nowrap">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-base">event</span>
              Eventos
            </span>
          </button>
          <button onclick="showAdminTab('tareas')" id="admin-tab-tareas" class="admin-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 font-medium text-xs sm:text-sm whitespace-nowrap">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-base">task</span>
              Tareas
            </span>
          </button>
          <button onclick="showAdminTab('limpieza')" id="admin-tab-limpieza" class="admin-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 font-medium text-sm whitespace-nowrap">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-base">cleaning_services</span>
              Limpieza
            </span>
          </button>
        </nav>
      </div>

      <!-- Panel: Usuarios (con scroll) -->
      <div id="admin-panel-usuarios" class="admin-tab-content">
        <div class="overflow-y-auto" style="max-height: 400px;">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Usuario</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Rol</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for u in admin_data.usuarios %}
              <tr>
                <td class="px-4 py-2 text-gray-900">{{ u.id }}</td>
                <td class="px-4 py-2 font-medium text-gray-900">{{ u.usuario }}</td>
                <td class="px-4 py-2">
                  {% if u.rol == 3 or u.rol == '3' %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">Admin</span>
                  {% else %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Usuario</span>
                  {% endif %}
                </td>
                <td class="px-4 py-2">
                  {% if u.rol != 3 and u.rol != '3' %}
                  <button type="button"
                          class="btn-delete-usuario text-red-600 hover:text-red-900"
                          data-usuario-id="{{ u.id }}"
                          data-usuario-nombre="{{ u.usuario }}">
                    <span class="material-symbols-outlined text-sm">delete</span>
                  </button>
                  {% else %}
                  <span class="text-gray-400 text-xs">Protegido</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Panel: Sesiones Activas -->
      <div id="admin-panel-sesiones" class="admin-tab-content hidden">
        <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded text-sm">
          <p class="text-blue-800 font-medium">ℹ️ Sesiones activas en el servidor (expiran tras 30 min de inactividad)</p>
        </div>
        <div class="overflow-y-auto" style="max-height: 400px;">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Usuario</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Última Actividad</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Inactivo (min)</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Token</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for s in admin_data.sesiones_activas %}
              <tr>
                <td class="px-4 py-2 font-medium text-gray-900">{{ s.usuario }}</td>
                <td class="px-4 py-2 text-gray-600 text-xs">{{ s.last_active }}</td>
                <td class="px-4 py-2">
                  {% if s.inactive_minutes < 5 %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">{{ s.inactive_minutes }} min</span>
                  {% elif s.inactive_minutes < 15 %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">{{ s.inactive_minutes }} min</span>
                  {% else %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">{{ s.inactive_minutes }} min</span>
                  {% endif %}
                </td>
                <td class="px-4 py-2 text-gray-500 text-xs font-mono">{{ s.token_preview }}</td>
                <td class="px-4 py-2">
                  <button type="button"
                          class="btn-cerrar-sesion text-red-600 hover:text-red-900 flex items-center gap-1 text-xs"
                          data-usuario="{{ s.usuario }}">
                    <span class="material-symbols-outlined text-sm">logout</span>
                    <span>Cerrar</span>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">No hay sesiones activas</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Panel: Eventos (con filtro y scroll) -->
      <div id="admin-panel-eventos" class="admin-tab-content hidden">
        <!-- Filtro por usuario -->
        <div class="mb-4">
          <label for="filtro-usuario-eventos" class="block text-sm font-medium text-gray-700 mb-2">Filtrar por usuario:</label>
          <select id="filtro-usuario-eventos" class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md text-sm bg-white" onchange="filtrarEventos()">
            <option value="">-- Todos los usuarios --</option>
            {% for u in admin_data.usuarios %}
              <option value="{{ u.id }}">{{ u.usuario }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="overflow-y-auto" style="max-height: 400px;">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Nombre</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Fecha</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Creador</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="eventos-tbody">
              {% for e in admin_data.eventos %}
              <tr data-creador-id="{{ e.creador_evento }}" class="evento-row">
                <td class="px-4 py-2 text-gray-900">{{ e.id }}</td>
                <td class="px-4 py-2 text-gray-900">{{ e.nombre }}</td>
                <td class="px-4 py-2 text-gray-600">{{ e.fecha_evento }}</td>
                <td class="px-4 py-2 text-gray-600">{{ e.creador_nombre }}</td>
                <td class="px-4 py-2">
                  <button type="button"
                          class="btn-delete-evento-admin text-red-600 hover:text-red-900"
                          data-evento-id="{{ e.id }}"
                          data-evento-nombre="{{ e.nombre }}">
                    <span class="material-symbols-outlined text-sm">delete</span>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr id="no-eventos-row"><td colspan="5" class="px-4 py-3 text-center text-gray-500">No hay eventos</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Panel: Tareas (con filtro y scroll) -->
      <div id="admin-panel-tareas" class="admin-tab-content hidden">
        <!-- Filtro por usuario -->
        <div class="mb-4">
          <label for="filtro-usuario-tareas" class="block text-sm font-medium text-gray-700 mb-2">Filtrar por usuario:</label>
          <select id="filtro-usuario-tareas" class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md text-sm bg-white" onchange="filtrarTareas()">
            <option value="">-- Todos los usuarios --</option>
            {% for u in admin_data.usuarios %}
              <option value="{{ u.id }}">{{ u.usuario }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="overflow-y-auto" style="max-height: 400px;">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Nombre</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Fecha Límite</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Estado</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Creador</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="tareas-tbody">
              {% for t in admin_data.tareas %}
              <tr data-creador-id="{{ t.creador_tarea }}" class="tarea-row">
                <td class="px-4 py-2 text-gray-900">{{ t.id }}</td>
                <td class="px-4 py-2 text-gray-900">{{ t.nombre }}</td>
                <td class="px-4 py-2 text-gray-600">{{ t.fecha_limite }}</td>
                <td class="px-4 py-2">
                  {% if t.estado == 1 %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Completada</span>
                  {% else %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendiente</span>
                  {% endif %}
                </td>
                <td class="px-4 py-2 text-gray-600">{{ t.creador_nombre }}</td>
                <td class="px-4 py-2">
                  <button type="button"
                          class="btn-delete-tarea-admin text-red-600 hover:text-red-900"
                          data-tarea-id="{{ t.id }}"
                          data-tarea-nombre="{{ t.nombre }}">
                    <span class="material-symbols-outlined text-sm">delete</span>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr id="no-tareas-row"><td colspan="6" class="px-4 py-3 text-center text-gray-500">No hay tareas</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Panel: Limpieza -->
      <div id="admin-panel-limpieza" class="admin-tab-content hidden">
        <p class="text-gray-600 mb-4">Elimina eventos y tareas cuya fecha haya pasado hace más de X días.</p>
        <form method="POST" action="{{ url_for('limpiar_datos_admin') }}" class="space-y-4" id="form-limpieza-usuario">
          <div>
            <label for="dias" class="block text-sm font-medium text-gray-700 mb-2">
              Eliminar datos con más de (días):
            </label>
            <input 
              type="number" 
              id="dias" 
              name="dias" 
              value="7"
              min="1"
              max="365"
              class="w-32 px-3 py-2 border border-gray-300 rounded-md text-sm"
            >
          </div>
          <div class="flex justify-end">
            <button 
              type="button"
              id="btn-confirmar-limpieza-usuario"
              class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold text-sm shadow-sm"
            >
              <span class="material-symbols-outlined text-base">delete_sweep</span>
              <span>Ejecutar Limpieza</span>
            </button>
          </div>
        </form>
        <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-sm">
          <p class="text-yellow-800 font-medium">⚠️ Esta acción eliminará permanentemente los datos antiguos.</p>
        </div>
      </div>
    </div>

    <style>
    .confirm-modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease-out;
    }
    .confirm-modal {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 400px;
        width: 90%;
        animation: slideUp 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    </style>

    <script>
    function showAdminTab(tabName) {
      // Ocultar todos los paneles
      document.querySelectorAll('.admin-tab-content').forEach(panel => {
        panel.classList.add('hidden');
      });
      
      // Remover estado activo de todos los tabs
      document.querySelectorAll('.admin-tab-btn').forEach(tab => {
        tab.classList.remove('border-purple-500', 'text-purple-600');
        tab.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Mostrar panel seleccionado
      document.getElementById('admin-panel-' + tabName).classList.remove('hidden');
      
      // Activar tab seleccionado
      const activeTab = document.getElementById('admin-tab-' + tabName);
      activeTab.classList.remove('border-transparent', 'text-gray-500');
      activeTab.classList.add('border-purple-500', 'text-purple-600');
    }
    
    function filtrarEventos() {
      const filtro = document.getElementById('filtro-usuario-eventos').value;
      const rows = document.querySelectorAll('.evento-row');
      let visibleCount = 0;
      
      rows.forEach(row => {
        if (!filtro || row.dataset.creadorId === filtro) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
      
      // Mostrar mensaje si no hay resultados
      const noEventosRow = document.getElementById('no-eventos-row');
      if (noEventosRow) {
        noEventosRow.style.display = visibleCount === 0 ? '' : 'none';
      }
    }
    
    function filtrarTareas() {
      const filtro = document.getElementById('filtro-usuario-tareas').value;
      const rows = document.querySelectorAll('.tarea-row');
      let visibleCount = 0;
      
      rows.forEach(row => {
        if (!filtro || row.dataset.creadorId === filtro) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
      
      // Mostrar mensaje si no hay resultados
      const noTareasRow = document.getElementById('no-tareas-row');
      if (noTareasRow) {
        noTareasRow.style.display = visibleCount === 0 ? '' : 'none';
      }
    }
    
    function mostrarConfirmacion(tipo, id, nombre, action) {
      const overlay = document.createElement('div');
      overlay.className = 'confirm-modal-overlay';
      
      let mensaje = '';
      let tituloTipo = '';
      
      if (tipo === 'usuario') {
          tituloTipo = 'usuario';
          mensaje = `Estás a punto de eliminar al usuario <strong>"${nombre}"</strong> y todos sus eventos y tareas. Esta acción no se puede deshacer.`;
      } else if (tipo === 'evento') {
          tituloTipo = 'evento';
          mensaje = `Estás a punto de eliminar el evento <strong>"${nombre}"</strong>. Esta acción no se puede deshacer.`;
      } else if (tipo === 'tarea') {
          tituloTipo = 'tarea';
          mensaje = `Estás a punto de eliminar la tarea <strong>"${nombre}"</strong>. Esta acción no se puede deshacer.`;
      } else if (tipo === 'sesion') {
          tituloTipo = 'cerrar sesión';
          mensaje = `Estás a punto de cerrar la sesión de <strong>"${nombre}"</strong>. El usuario deberá iniciar sesión nuevamente.`;
      } else if (tipo === 'limpieza') {
          tituloTipo = 'limpieza de datos';
          mensaje = `Estás a punto de ejecutar la limpieza de datos antiguos. Esta acción eliminará permanentemente eventos y tareas antiguas y no se puede deshacer.`;
      }
      
      overlay.innerHTML = `
          <div class="confirm-modal">
              <div class="flex items-start gap-3 mb-4">
                  <div class="flex-shrink-0">
                      <span class="material-symbols-outlined text-red-500 text-3xl">warning</span>
                  </div>
                  <div class="flex-1">
                      <h3 class="text-lg font-bold text-gray-900 mb-2">¿Confirmar ${tituloTipo}?</h3>
                      <p class="text-sm text-gray-600">${mensaje}</p>
                  </div>
              </div>
              <div class="flex gap-3 justify-end">
                  <button id="btn-cancelar" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium transition-colors">
                      Cancelar
                  </button>
                  <button id="btn-confirmar" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 font-medium transition-colors">
                      Confirmar
                  </button>
              </div>
          </div>
      `;
      
      document.body.appendChild(overlay);
      
      overlay.addEventListener('click', (e) => {
          if (e.target === overlay) overlay.remove();
      });
      
      overlay.querySelector('#btn-cancelar').addEventListener('click', () => overlay.remove());
      
      overlay.querySelector('#btn-confirmar').addEventListener('click', () => {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = action;
          
          if (tipo === 'usuario') {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'usuario_id';
              input.value = id;
              form.appendChild(input);
          } else if (tipo === 'evento') {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'evento_id';
              input.value = id;
              form.appendChild(input);
          } else if (tipo === 'tarea') {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'tarea_id';
              input.value = id;
              form.appendChild(input);
          } else if (tipo === 'sesion') {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'usuario';
              input.value = nombre;
              form.appendChild(input);
          } else if (tipo === 'limpieza') {
              const diasInput = document.createElement('input');
              diasInput.type = 'hidden';
              diasInput.name = 'dias';
              diasInput.value = document.getElementById('dias').value;
              form.appendChild(diasInput);
          }
          
          document.body.appendChild(form);
          form.submit();
      });
    }
    
    // Event listeners para botones de eliminar
    document.addEventListener('DOMContentLoaded', function() {
        // Eliminar usuarios
        document.querySelectorAll('.btn-delete-usuario').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.usuarioId;
                const nombre = this.dataset.usuarioNombre;
                mostrarConfirmacion('usuario', id, nombre, '{{ url_for("eliminar_usuario_admin") }}');
            });
        });
        
        // Cerrar sesiones
        document.querySelectorAll('.btn-cerrar-sesion').forEach(btn => {
            btn.addEventListener('click', function() {
                const usuario = this.dataset.usuario;
                mostrarConfirmacion('sesion', null, usuario, '{{ url_for("cerrar_sesion_usuario_admin") }}');
            });
        });
        
        // Eliminar eventos
        document.querySelectorAll('.btn-delete-evento-admin').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.eventoId;
                const nombre = this.dataset.eventoNombre;
                mostrarConfirmacion('evento', id, nombre, '{{ url_for("eliminar_evento_admin") }}');
            });
        });
        
        // Eliminar tareas
        document.querySelectorAll('.btn-delete-tarea-admin').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.tareaId;
                const nombre = this.dataset.tareaNombre;
                mostrarConfirmacion('tarea', id, nombre, '{{ url_for("eliminar_tarea_admin") }}');
            });
        });
        
        // Limpieza de datos
        const btnLimpieza = document.getElementById('btn-confirmar-limpieza-usuario');
        if (btnLimpieza) {
            btnLimpieza.addEventListener('click', function() {
                mostrarConfirmacion('limpieza', null, null, '{{ url_for("limpiar_datos_admin") }}');
            });
        }
    });
    </script>
    {% endif %}

    <script>
    function togglePasswordVisibility(inputId, eyeId) {
        const input = document.getElementById(inputId);
        const eye = document.getElementById(eyeId);
        
        if (input.type === 'password') {
            input.type = 'text';
            eye.textContent = 'visibility_off';
        } else {
            input.type = 'password';
            eye.textContent = 'visibility';
        }
    }
    </script>

    <!-- Botón volver -->
    <div class="text-center">
      <a 
        href="{{ url_for('dashboard') }}"
        class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
      >
        <span class="material-symbols-outlined">arrow_back</span>
        <span>Volver al Panel Principal</span>
      </a>
    </div>
  </div>
</div>

{% endblock %}
